# ç§»åŠ¨ç«¯æ™ºèƒ½åŠ©æ‰‹å‡çº§ - å¤åˆ»Webç«¯åŠŸèƒ½

## å®æ–½æ¦‚è¿°

æœ¬æ¬¡å‡çº§å°†Webç«¯æ™ºèƒ½åŠ©æ‰‹çš„å®Œæ•´åŠŸèƒ½å¤åˆ»åˆ°ç§»åŠ¨ç«¯ï¼ŒåŒ…æ‹¬è½®æ¬¡è¿½è¸ªã€æ€»ç»“ç”Ÿæˆã€å¯¹è¯çŠ¶æ€ç®¡ç†ç­‰æ ¸å¿ƒç‰¹æ€§ã€‚

## æ–°å¢åŠŸèƒ½

### 1. å¯¹è¯è½®æ¬¡è¿½è¸ª (Round Progress Tracking)

**åŠŸèƒ½æè¿°**:
- å®æ—¶æ˜¾ç¤ºå½“å‰å¯¹è¯è½®æ¬¡ (1-5è½®)
- å¯è§†åŒ–è¿›åº¦æ¡å±•ç¤ºå¯¹è¯è¿›åº¦
- è‡ªåŠ¨è®°å½•æ¯è½®å¯¹è¯çš„å†å²

**å®ç°ä½ç½®**: `mobile/app/(tabs)/conversations/[id].tsx`

**çŠ¶æ€ç®¡ç†**:
```typescript
const [currentRound, setCurrentRound] = useState(0);
const [dialogueHistory, setDialogueHistory] = useState<Array<{
  round: number;
  userMessage: string;
  aiQuestion: string;
  timestamp: Date;
}>>([]);
```

**UIå±•ç¤º**:
- ä½ç½®: æ™ºèƒ½åŠ©æ‰‹æŠ½å±‰é¡¶éƒ¨å³ä¾§
- æ ¼å¼: "ç¬¬ X/5 è½®" + è¿›åº¦æ¡
- é¢œè‰²: è“è‰²è¿›åº¦æ¡ (#3B82F6)

### 2. å¯¹è¯æ€»ç»“ç”Ÿæˆ (Summary Generation)

**åŠŸèƒ½æè¿°**:
- æ”¯æŒæµå¼æ€»ç»“ç”Ÿæˆ
- å®æ—¶æ˜¾ç¤ºæ€»ç»“å†…å®¹
- æ ‡è®°å¯¹è¯ç»“æŸçŠ¶æ€

**å®ç°ä½ç½®**: `handleGenerateSummary` å‡½æ•°

**APIå¯¹æ¥**:
```typescript
POST /api/conversations/:id/summary
Body: { rounds: dialogueHistory }
Response: æµå¼ JSON (type: 'chunk' | 'complete' | 'error')
```

**çŠ¶æ€ç®¡ç†**:
```typescript
const [summaryContent, setSummaryContent] = useState('');
const [showSummary, setShowSummary] = useState(false);
const [conversationEnded, setConversationEnded] = useState(false);
```

### 3. æ™ºèƒ½æŒ‰é’®æ–‡æ¡ˆ (Smart Button Text)

**åŠŸèƒ½æè¿°**:
- ç¬¬1-4è½®: "ç”Ÿæˆæ€ç»´æ€»ç»“" (æ¬¡è¦æŒ‰é’®)
- ç¬¬5è½®: "ç»“æŸå¹¶ç”Ÿæˆæ€»ç»“" (ä¸»è¦æŒ‰é’®)
- å·²ç”Ÿæˆæ€»ç»“å: éšè—æŒ‰é’®

**å®ç°é€»è¾‘**:
```typescript
{!conversationEnded && currentRound >= 1 && (
  <Button
    title={currentRound >= 5 ? 'ç»“æŸå¹¶ç”Ÿæˆæ€»ç»“' : 'ç”Ÿæˆæ€ç»´æ€»ç»“'}
    variant={currentRound >= 5 ? 'primary' : 'secondary'}
  />
)}
```

### 4. å¯¹è¯ç»“æŸçŠ¶æ€ç®¡ç† (Conversation End State)

**åŠŸèƒ½æè¿°**:
- ç”Ÿæˆæ€»ç»“åæ ‡è®°å¯¹è¯å·²ç»“æŸ
- æ˜¾ç¤º"ç»§ç»­è¿½é—®"å’Œ"å…³é—­"æŒ‰é’®
- ç”¨æˆ·å¯é€‰æ‹©ç»§ç»­å¯¹è¯æˆ–ç»“æŸ

**UIå¸ƒå±€**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“Š å¯¹è¯æ€»ç»“                         â”‚
â”‚  [æ€»ç»“å†…å®¹æ»šåŠ¨åŒºåŸŸ]                  â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ç»§ç»­è¿½é—®   â”‚  â”‚  å…³é—­    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**äº¤äº’é€»è¾‘**:
- "ç»§ç»­è¿½é—®": é‡ç½® conversationEnded, å…³é—­æ€»ç»“æ˜¾ç¤º, å…³é—­åŠ©æ‰‹æŠ½å±‰
- "å…³é—­": ä»…å…³é—­åŠ©æ‰‹æŠ½å±‰

### 5. éš¾åº¦æ ‡ç­¾æ˜¾ç¤º (Difficulty Badges)

**å·²æœ‰åŠŸèƒ½å¢å¼º**:
- å…¥é—¨ (ğŸŒ± Simple): ç»¿è‰²èƒŒæ™¯
- è¿›é˜¶ (ğŸŒ¿ Moderate): é»„è‰²èƒŒæ™¯
- æ·±åº¦ (ğŸŒ³ Deep): ç´«è‰²èƒŒæ™¯

**å…¼å®¹æ€§å¤„ç†**:
```typescript
const difficulty = suggestion.difficulty ||
  (index === 0 ? 'simple' : index === 1 ? 'moderate' : 'deep');
```

## æŠ€æœ¯å®ç°ç»†èŠ‚

### è½®æ¬¡è¿½è¸ªé€»è¾‘

**è§¦å‘æ—¶æœº**: AIå›å¤å®Œæˆå (useEffectç›‘å¬)

**è®¡ç®—æ–¹å¼**:
```typescript
const userMessages = conversation.messages.filter(m => m.role === 'user');
const newRound = Math.ceil(userMessages.length / 1);
```

**å†å²è®°å½•æ›´æ–°**:
```typescript
setDialogueHistory(prev => [...prev, {
  round: newRound,
  userMessage: lastUserMsg.content,
  aiQuestion: lastMessage.content,
  timestamp: new Date()
}]);
```

### æ€»ç»“ç”Ÿæˆæµç¨‹

**æ­¥éª¤1: åˆå§‹åŒ–**
```typescript
setSummaryContent('ğŸ“Š æ­£åœ¨ç”Ÿæˆå¯¹è¯æ€»ç»“...\n\n');
setShowSummary(true);
```

**æ­¥éª¤2: å‘èµ·è¯·æ±‚**
```typescript
const response = await fetch(`${API_CONFIG.BASE_URL}/conversations/${id}/summary`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`,
  },
  body: JSON.stringify({ rounds: dialogueHistory }),
});
```

**æ­¥éª¤3: æµå¼å¤„ç†**
```typescript
const reader = response.body?.getReader();
const decoder = new TextDecoder();

while (true) {
  const { done, value } = await reader.read();
  if (done) break;

  buffer += decoder.decode(value, { stream: true });
  const lines = buffer.split('\n');
  buffer = lines.pop() || '';

  for (const line of lines) {
    const data = JSON.parse(line);
    if (data.type === 'chunk' && data.content) {
      content += data.content;
      setSummaryContent(content);
    } else if (data.type === 'complete') {
      setConversationEnded(true);
    }
  }
}
```

### æ™ºèƒ½åŠ©æ‰‹æŠ½å±‰UIå¢å¼º

**å¸ƒå±€ç»“æ„**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ’¡ æ™ºèƒ½åŠ©æ‰‹     ç¬¬ 3/5 è½® [===  ]  â”‚ <- æ ‡é¢˜ + è¿›åº¦
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“Š å¯¹è¯æ€»ç»“ (å¦‚æœå·²ç”Ÿæˆ)            â”‚
â”‚  [æ€»ç»“å†…å®¹]                          â”‚
â”‚  [ç»§ç»­è¿½é—®] [å…³é—­]                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸŒ± å…¥é—¨                             â”‚
â”‚  å»ºè®®ç­”æ¡ˆ1...                        â”‚
â”‚  ğŸ’¡ æé—®æ„å›¾                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸŒ¿ è¿›é˜¶                             â”‚
â”‚  å»ºè®®ç­”æ¡ˆ2...                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ç”Ÿæˆæ€ç»´æ€»ç»“] æˆ– [ç»“æŸå¹¶ç”Ÿæˆæ€»ç»“]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ¡ä»¶æ¸²æŸ“é€»è¾‘**:
1. å¦‚æœ `showSummary`: æ˜¾ç¤ºæ€»ç»“å†…å®¹ + æŒ‰é’®
2. å¦‚æœ `!showSummary`: æ˜¾ç¤ºå»ºè®®ç­”æ¡ˆåˆ—è¡¨
3. æ€»ç»“æŒ‰é’®: `currentRound >= 1 && !conversationEnded`

## ä¸Webç«¯å¯¹æ¯”

| åŠŸèƒ½ | Webç«¯ | ç§»åŠ¨ç«¯ (å‡çº§å) | çŠ¶æ€ |
|-----|-------|----------------|------|
| è½®æ¬¡è¿½è¸ª | âœ… | âœ… | å·²å®ç° |
| è¿›åº¦æ¡æ˜¾ç¤º | âœ… | âœ… | å·²å®ç° |
| éš¾åº¦æ ‡ç­¾ | âœ… | âœ… | å·²å®ç° |
| æ„å›¾è¯´æ˜ | âœ… | âœ… | å·²å®ç° |
| æµå¼æ€»ç»“ | âœ… | âœ… | å·²å®ç° |
| å¯¹è¯ç»“æŸçŠ¶æ€ | âœ… | âœ… | å·²å®ç° |
| ç»§ç»­è¿½é—®æŒ‰é’® | âœ… | âœ… | å·²å®ç° |
| æœ¬åœ°çŠ¶æ€æŒä¹…åŒ– | localStorage | - | å¾…å®ç° |

## å¾…ä¼˜åŒ–é¡¹

### 1. çŠ¶æ€æŒä¹…åŒ–

**å½“å‰çŠ¶æ€**: ä»…å­˜åœ¨å†…å­˜ä¸­ï¼Œåˆ·æ–°åä¸¢å¤±

**å»ºè®®å®ç°**:
```typescript
import { MMKV } from 'react-native-mmkv';

const storage = new MMKV();

// ä¿å­˜å¯¹è¯ç»“æŸçŠ¶æ€
useEffect(() => {
  if (conversationEnded) {
    storage.set(`conversation_${id}_ended`, 'true');
  }
}, [conversationEnded, id]);

// æ¢å¤çŠ¶æ€
useEffect(() => {
  const ended = storage.getString(`conversation_${id}_ended`);
  if (ended === 'true') {
    setConversationEnded(true);
  }
}, [id]);
```

### 2. æ€»ç»“å†…å®¹æŒä¹…åŒ–

**å»ºè®®**: å°†æ€»ç»“ä¿å­˜åˆ°æ¶ˆæ¯åˆ—è¡¨ä¸­ (å‚è€ƒWebç«¯)

```typescript
// åœ¨æ€»ç»“å®Œæˆå
await conversationService.sendMessage({
  conversationId: id,
  content: summaryContent,
  role: 'assistant'
});
```

### 3. Markdownæ¸²æŸ“æ”¯æŒ

**å½“å‰**: çº¯æ–‡æœ¬æ˜¾ç¤ºæ€»ç»“

**å»ºè®®**: ä½¿ç”¨ `MarkdownRenderer` ç»„ä»¶æ¸²æŸ“æ€»ç»“å†…å®¹

```typescript
import { MarkdownRenderer } from '@/src/components/MarkdownRenderer';

<MarkdownRenderer content={summaryContent} />
```

## æµ‹è¯•å»ºè®®

### åŠŸèƒ½æµ‹è¯•

1. **è½®æ¬¡è¿½è¸ª**:
   - [ ] å‘é€ç¬¬1æ¡æ¶ˆæ¯ â†’ æ˜¾ç¤º"ç¬¬ 1/5 è½®"
   - [ ] å‘é€ç¬¬5æ¡æ¶ˆæ¯ â†’ æ˜¾ç¤º"ç¬¬ 5/5 è½®"
   - [ ] è¿›åº¦æ¡å®½åº¦æ­£ç¡® (1/5 = 20%, 5/5 = 100%)

2. **æ€»ç»“ç”Ÿæˆ**:
   - [ ] ç¬¬1-4è½®æ˜¾ç¤º"ç”Ÿæˆæ€ç»´æ€»ç»“"æŒ‰é’®
   - [ ] ç¬¬5è½®æ˜¾ç¤º"ç»“æŸå¹¶ç”Ÿæˆæ€»ç»“"æŒ‰é’®
   - [ ] ç‚¹å‡»æŒ‰é’®åæ˜¾ç¤ºæµå¼æ€»ç»“
   - [ ] æ€»ç»“å®Œæˆåæ˜¾ç¤º"ç»§ç»­è¿½é—®"å’Œ"å…³é—­"æŒ‰é’®

3. **å¯¹è¯ç»“æŸçŠ¶æ€**:
   - [ ] ç‚¹å‡»"ç»§ç»­è¿½é—®" â†’ conversationEndedé‡ç½®ä¸ºfalse
   - [ ] ç‚¹å‡»"å…³é—­" â†’ åŠ©æ‰‹æŠ½å±‰å…³é—­
   - [ ] å†æ¬¡æ‰“å¼€åŠ©æ‰‹ â†’ æ˜¾ç¤ºä¹‹å‰çš„æ€»ç»“å†…å®¹

4. **å»ºè®®ç­”æ¡ˆ**:
   - [ ] æ˜¾ç¤ºéš¾åº¦æ ‡ç­¾ (ğŸŒ±/ğŸŒ¿/ğŸŒ³)
   - [ ] æ˜¾ç¤ºæ„å›¾è¯´æ˜
   - [ ] ç‚¹å‡»å»ºè®® â†’ å¡«å…¥è¾“å…¥æ¡†å¹¶å…³é—­åŠ©æ‰‹

### è¾¹ç•Œæµ‹è¯•

1. **æ— æ¶ˆæ¯çŠ¶æ€**:
   - [ ] 0æ¡æ¶ˆæ¯ â†’ ä¸æ˜¾ç¤ºè½®æ¬¡
   - [ ] 0æ¡æ¶ˆæ¯ â†’ ä¸æ˜¾ç¤ºæ€»ç»“æŒ‰é’®

2. **ç½‘ç»œé”™è¯¯**:
   - [ ] APIå¤±è´¥ â†’ æ˜¾ç¤º"âŒ ç”Ÿæˆæ€»ç»“å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•"
   - [ ] ç½‘ç»œè¶…æ—¶ â†’ æ­£ç¡®å¤„ç†é”™è¯¯

3. **é‡å¤æ“ä½œ**:
   - [ ] å·²ç”Ÿæˆæ€»ç»“ â†’ å†æ¬¡ç‚¹å‡»æŒ‰é’® â†’ æ˜¾ç¤ºä¹‹å‰çš„æ€»ç»“
   - [ ] åŒä¸€æ¡AIæ¶ˆæ¯ â†’ ä¸é‡å¤ç”Ÿæˆå»ºè®®

## æ–‡ä»¶å˜æ›´æ¸…å•

### ä¿®æ”¹æ–‡ä»¶

- `mobile/app/(tabs)/conversations/[id].tsx`:
  - æ–°å¢çŠ¶æ€: currentRound, dialogueHistory, conversationEnded, summaryContent, showSummary
  - å¢å¼º useEffect: æ·»åŠ è½®æ¬¡è¿½è¸ªé€»è¾‘
  - é‡å†™ handleGenerateSummary: æ”¯æŒæµå¼æ€»ç»“
  - å¢å¼ºæ™ºèƒ½åŠ©æ‰‹UI: è¿›åº¦æ¡ + æ€»ç»“æ˜¾ç¤º + æ¡ä»¶æŒ‰é’®

### æœªä¿®æ”¹æ–‡ä»¶

- `mobile/src/services/conversation.service.ts`: APIæœåŠ¡ä¿æŒä¸å˜
- `mobile/src/hooks/useConversations.ts`: React Query hooksä¿æŒä¸å˜
- `mobile/src/types/conversation.ts`: ç±»å‹å®šä¹‰ä¿æŒä¸å˜

## APIä¾èµ–

### POST /api/conversations/:id/summary

**è¯·æ±‚ä½“**:
```json
{
  "rounds": [
    {
      "round": 1,
      "userMessage": "ç”¨æˆ·æ¶ˆæ¯",
      "aiQuestion": "AIé—®é¢˜",
      "timestamp": "2025-10-08T13:00:00.000Z"
    }
  ]
}
```

**å“åº”æµ**:
```
data: {"type":"chunk","content":"æ€»ç»“å†…å®¹ç‰‡æ®µ"}
data: {"type":"chunk","content":"..."}
data: {"type":"complete"}
```

**é”™è¯¯å“åº”**:
```
data: {"type":"error","error":"é”™è¯¯ä¿¡æ¯"}
```

## éƒ¨ç½²è¯´æ˜

### æ— éœ€é¢å¤–ä¾èµ–

æœ¬æ¬¡å‡çº§ä»…ä½¿ç”¨ç°æœ‰ä¾èµ–ï¼Œæ— éœ€å®‰è£…æ–°åŒ…ã€‚

### ç¯å¢ƒå˜é‡

ç¡®ä¿ `.env` æ–‡ä»¶åŒ…å«:
```
EXPO_PUBLIC_DASHSCOPE_API_KEY=your_api_key_here
```

### æ„å»ºæ­¥éª¤

```bash
cd mobile
npm install  # ç¡®ä¿ä¾èµ–å·²å®‰è£…
npx expo start --clear  # æ¸…é™¤ç¼“å­˜å¹¶å¯åŠ¨
```

## æ€»ç»“

æœ¬æ¬¡å‡çº§æˆåŠŸå°†Webç«¯æ™ºèƒ½åŠ©æ‰‹çš„å®Œæ•´åŠŸèƒ½å¤åˆ»åˆ°ç§»åŠ¨ç«¯ï¼ŒåŒ…æ‹¬:

1. âœ… è½®æ¬¡è¿›åº¦è¿½è¸ª (1-5è½®å¯è§†åŒ–)
2. âœ… å¯¹è¯å†å²è®°å½• (round + userMessage + aiQuestion)
3. âœ… æµå¼æ€»ç»“ç”Ÿæˆ (å®æ—¶æ˜¾ç¤ºæ€»ç»“å†…å®¹)
4. âœ… å¯¹è¯ç»“æŸçŠ¶æ€ç®¡ç† (conversationEndedæ ‡è®°)
5. âœ… æ™ºèƒ½æŒ‰é’®æ–‡æ¡ˆ (æ ¹æ®è½®æ¬¡åŠ¨æ€è°ƒæ•´)
6. âœ… ç»§ç»­è¿½é—®/å…³é—­é€‰é¡¹ (æ€»ç»“åçš„äº¤äº’)
7. âœ… éš¾åº¦æ ‡ç­¾æ˜¾ç¤º (ğŸŒ±/ğŸŒ¿/ğŸŒ³)
8. âœ… æ„å›¾è¯´æ˜æ˜¾ç¤º (suggestion.intent)

ç§»åŠ¨ç«¯ç°åœ¨ä¸Webç«¯åŠŸèƒ½å¯¹ç­‰ï¼Œä¸ºç”¨æˆ·æä¾›äº†å®Œæ•´çš„å¯¹è¯å¼•å¯¼å’Œæ€»ç»“ä½“éªŒã€‚
