# 智能助手新功能演示

## 功能概览

移动端现已完全复刻Web端智能助手功能，包括：

1. ✅ **轮次进度追踪** - 第 X/5 轮 + 进度条
2. ✅ **智能按钮文案** - 根据轮次自动调整
3. ✅ **流式总结生成** - 实时显示总结内容
4. ✅ **对话结束管理** - "继续追问" / "关闭" 选项

## 视觉演示

### 第1轮 - 初始状态

```
┌─────────────────────────────────────┐
│ 💡 智能助手     第 1/5 轮 [■□□□□]   │
├─────────────────────────────────────┤
│ 🌱 入门                             │
│ 建议答案1: 这个问题让我想到...      │
│ 💡 引导你从个人经历的角度思考       │
├─────────────────────────────────────┤
│ 🌿 进阶                             │
│ 建议答案2: 从另一个角度来看...      │
│ 💡 拓展思考的深度和广度             │
├─────────────────────────────────────┤
│ 🌳 深度                             │
│ 建议答案3: 如果追根溯源...          │
│ 💡 挑战你进行批判性思考             │
├─────────────────────────────────────┤
│        [生成思维总结]                │  <- 次要按钮（灰色）
└─────────────────────────────────────┘
```

### 第5轮 - 可以结束

```
┌─────────────────────────────────────┐
│ 💡 智能助手     第 5/5 轮 [■■■■■]   │
├─────────────────────────────────────┤
│ 🌱 入门                             │
│ 建议答案1...                        │
├─────────────────────────────────────┤
│ 🌿 进阶                             │
│ 建议答案2...                        │
├─────────────────────────────────────┤
│ 🌳 深度                             │
│ 建议答案3...                        │
├─────────────────────────────────────┤
│      [结束并生成总结]                │  <- 主要按钮（蓝色）
└─────────────────────────────────────┘
```

### 总结生成中 - 流式显示

```
┌─────────────────────────────────────┐
│ 💡 智能助手     第 5/5 轮 [■■■■■]   │
├─────────────────────────────────────┤
│ 📊 对话总结                          │
│                                     │
│ 经过5轮深入对话，我们探讨了...      │
│                                     │
│ ## 核心洞察                         │
│ 1. 你的核心观点是...               │  <- 实时流式显示
│ 2. 我们发现...                      │
│                                     │
│ ## 思维演进                         │
│ 从最初的...                         │  <- 内容逐步增加
└─────────────────────────────────────┘
```

### 总结完成 - 可选择继续或结束

```
┌─────────────────────────────────────┐
│ 💡 智能助手     第 5/5 轮 [■■■■■]   │
├─────────────────────────────────────┤
│ 📊 对话总结                          │
│                                     │
│ 经过5轮深入对话，我们探讨了...      │
│                                     │
│ ## 核心洞察                         │
│ 1. 你的核心观点是...               │
│ 2. 我们发现了以下关键点...          │
│ 3. 你的思维从X演变到Y              │
│                                     │
│ ## 思维演进                         │
│ 从最初的困惑到现在的清晰，你经历了... │
│                                     │
│ ## 下一步建议                       │
│ 1. 建议你深入探索...               │
│ 2. 可以尝试...                      │
│                                     │
│ ┌──────────┐  ┌──────────┐         │
│ │继续追问   │  │  关闭    │         │  <- 对话结束选项
│ └──────────┘  └──────────┘         │
└─────────────────────────────────────┘
```

### 点击"继续追问"后 - 重置状态

```
┌─────────────────────────────────────┐
│ 💡 智能助手     第 5/5 轮 [■■■■■]   │
├─────────────────────────────────────┤
│ 🌱 入门                             │
│ 新的建议答案1...                    │  <- 回到建议答案模式
├─────────────────────────────────────┤
│ 🌿 进阶                             │
│ 新的建议答案2...                    │
├─────────────────────────────────────┤
│ 🌳 深度                             │
│ 新的建议答案3...                    │
├─────────────────────────────────────┤
│      [生成思维总结]                  │  <- 按钮再次出现
└─────────────────────────────────────┘
```

## 交互流程图

```
开始对话
   │
   ▼
发送消息 (第1轮)
   │
   ▼
打开助手抽屉
   │
   ├─ 显示: 第 1/5 轮 (20%进度)
   ├─ 显示: 3个难度分级的建议
   └─ 显示: "生成思维总结" (灰色按钮)
   │
   ▼
继续对话 (第2-4轮)
   │
   ├─ 进度更新: 第 2/5, 3/5, 4/5
   └─ 按钮保持: "生成思维总结"
   │
   ▼
第5轮对话
   │
   ├─ 进度: 第 5/5 轮 (100%)
   └─ 按钮变为: "结束并生成总结" (蓝色)
   │
   ▼
点击"结束并生成总结"
   │
   ├─ 隐藏建议答案
   ├─ 显示总结区域 (紫色背景)
   └─ 流式生成总结内容
   │
   ▼
总结完成
   │
   ├─ 显示完整总结
   └─ 显示两个按钮
        │
        ├─ "继续追问"
        │    │
        │    ├─ 关闭助手抽屉
        │    ├─ 重置 conversationEnded = false
        │    └─ 可继续发送消息
        │
        └─ "关闭"
             │
             ├─ 关闭助手抽屉
             └─ 保持 conversationEnded = true
```

## 关键技术点

### 1. 轮次计算

```typescript
// 基于用户消息数量计算轮次
const userMessages = conversation.messages.filter(m => m.role === 'user');
const newRound = Math.ceil(userMessages.length / 1);
```

### 2. 对话历史记录

```typescript
// 记录每轮的完整上下文
setDialogueHistory(prev => [...prev, {
  round: newRound,
  userMessage: lastUserMsg.content,
  aiQuestion: lastMessage.content,
  timestamp: new Date()
}]);
```

### 3. 流式总结生成

```typescript
// 使用 Fetch API + ReadableStream
const reader = response.body?.getReader();
const decoder = new TextDecoder();

while (true) {
  const { done, value } = await reader.read();
  if (done) break;

  // 逐步更新总结内容
  buffer += decoder.decode(value, { stream: true });
  const lines = buffer.split('\n');

  for (const line of lines) {
    const data = JSON.parse(line);
    if (data.type === 'chunk') {
      content += data.content;
      setSummaryContent(content);  // 实时更新UI
    }
  }
}
```

### 4. 条件渲染逻辑

```typescript
// 总结按钮显示条件
{!conversationEnded && currentRound >= 1 && (
  <Button
    title={currentRound >= 5 ? '结束并生成总结' : '生成思维总结'}
    variant={currentRound >= 5 ? 'primary' : 'secondary'}
  />
)}

// 总结内容显示条件
{showSummary && summaryContent && (
  <View>
    {/* 总结内容 */}
    {conversationEnded && (
      <View>
        {/* "继续追问" 和 "关闭" 按钮 */}
      </View>
    )}
  </View>
)}

// 建议答案显示条件
{!showSummary && (
  <View>
    {/* 建议答案列表 */}
  </View>
)}
```

## 状态管理

### 核心状态

```typescript
const [currentRound, setCurrentRound] = useState(0);
const [dialogueHistory, setDialogueHistory] = useState([]);
const [conversationEnded, setConversationEnded] = useState(false);
const [summaryContent, setSummaryContent] = useState('');
const [showSummary, setShowSummary] = useState(false);
```

### 状态转换

```
初始状态:
  currentRound = 0
  conversationEnded = false
  showSummary = false

第1轮对话后:
  currentRound = 1
  dialogueHistory = [{ round: 1, ... }]

第5轮对话后:
  currentRound = 5
  dialogueHistory = [{ round: 1 }, ..., { round: 5 }]

点击"结束并生成总结":
  showSummary = true
  summaryContent = "📊 正在生成对话总结..."

总结完成:
  conversationEnded = true
  summaryContent = "完整总结内容"

点击"继续追问":
  conversationEnded = false
  showSummary = false
  (currentRound 保持不变)
```

## API对接

### 总结生成接口

```http
POST /api/conversations/:id/summary

请求头:
  Content-Type: application/json
  Authorization: Bearer <token>

请求体:
{
  "rounds": [
    {
      "round": 1,
      "userMessage": "用户的回答",
      "aiQuestion": "AI的问题",
      "timestamp": "2025-10-08T14:00:00.000Z"
    },
    ...
  ]
}

响应 (流式):
data: {"type":"chunk","content":"经过5轮"}
data: {"type":"chunk","content":"深入对话"}
data: {"type":"chunk","content":"，我们"}
...
data: {"type":"complete"}
```

## 样式配置

### 颜色方案

- **进度条**: `bg-blue-600` (#3B82F6)
- **总结背景**: `bg-purple-50` (淡紫色)
- **继续追问按钮**: `bg-blue-600` (蓝色)
- **关闭按钮**: `bg-gray-200` (灰色)
- **主要按钮**: `bg-blue-600` (第5轮的"结束并生成总结")
- **次要按钮**: `bg-gray-200` (第1-4轮的"生成思维总结")

### 布局尺寸

- **进度条宽度**: 80px (w-20)
- **进度条高度**: 8px (h-2)
- **总结区域最大高度**: 256px (max-h-64)
- **按钮高度**: 48px (py-3)

## 与Web端对比

| 特性 | Web端 | 移动端 | 备注 |
|-----|-------|--------|------|
| 轮次显示 | ✅ 顶部 | ✅ 助手抽屉 | 位置适配移动端 |
| 进度条 | ✅ | ✅ | 样式一致 |
| 按钮文案 | ✅ 动态 | ✅ 动态 | 逻辑相同 |
| 流式总结 | ✅ SSE | ✅ Fetch Stream | 技术不同，效果相同 |
| 对话结束 | ✅ | ✅ | 完全一致 |
| 状态持久化 | ✅ localStorage | ⏳ 计划中 | 移动端将用MMKV |

## 用户体验亮点

### 1. 视觉反馈清晰
- 进度条直观显示对话进展
- 按钮颜色变化提示重要节点
- 流式显示让等待更有耐心

### 2. 交互逻辑合理
- 第5轮自动提示可以结束
- "继续追问"允许灵活延长对话
- "关闭"保留总结供后续查看

### 3. 信息层次分明
- 难度标签帮助用户选择
- 意图说明解释AI目的
- 总结区域紫色背景突出重要性

## 下一步计划

### 短期优化 (1-2天)
- [ ] 添加状态持久化 (MMKV)
- [ ] 总结保存到消息列表
- [ ] Markdown渲染支持

### 中期优化 (1周)
- [ ] 添加总结导出功能
- [ ] 优化总结生成动画
- [ ] 支持总结编辑

### 长期优化 (1个月)
- [ ] 多轮对话总结对比
- [ ] 思维地图可视化
- [ ] AI总结质量评分
